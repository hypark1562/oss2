name: LoL-Data-Pipeline-Automation

on:
  schedule:
    # Automated daily execution at 00:00 KST (15:00 UTC)
    - cron: '0 15 * * *'
  push:
    # Trigger on code updates to ensure pipeline integrity
    branches: [ master, main ]

jobs:
  pipeline:
    name: Continuous Integration & Data Execution
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v3

      - name: Initialize Python Environment
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Runtime Dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install pytest flake8

      # Phase 1: Static Code Analysis (Linting)
      # Ensures code adheres to PEP8 standards and catches syntax errors early
      - name: Static Code Analysis (flake8)
        run: flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics

      # Phase 2: Integration Testing
      # Validates environment configurations and API connectivity
      - name: Run Integration Tests
        env:
          RIOT_API_KEY: ${{ secrets.RIOT_API_KEY }}
          DB_URL: ${{ secrets.DB_URL }}
        run: pytest tests/test_config.py

      # Phase 3: Production ETL Execution
      # Orchestrates the core Extract, Transform, and Load process
      - name: Execute Production Pipeline
        env:
          RIOT_API_KEY: ${{ secrets.RIOT_API_KEY }}
          DB_URL: ${{ secrets.DB_URL }}
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: python main.py
